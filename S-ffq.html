<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>å†œåŒº FFQ è·³è·ƒå¼é—®å·</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { padding: 2rem; background: #f8f9fa; }
    .category-block { margin-bottom: 1.5rem; padding: 1rem; background: #fff; border-radius: 8px; box-shadow: 0 0 6px rgba(0,0,0,0.05); }
    .subitems { margin-left: 2rem; }
    .hidden { display: none; }
    .freq-options label { margin-right: 10px; }
  </style>
</head>
<body>
  <div class="container">
    <h2 class="mb-4">è†³é£Ÿé¢‘ç‡é—®å·ï¼ˆFFQï¼‰</h2>
    <div class="mb-3">
      <label for="userId" class="form-label">å—è¯•è€…ç¼–å·ï¼š</label>
      <input type="text" class="form-control" id="userId" placeholder="è¯·è¾“å…¥ID">
    </div>
    <div id="ffqForm"></div>
    <div class="d-flex gap-2 mt-4">
      <button class="btn btn-secondary" onclick="saveForm(true)">ä¿å­˜é—®å·</button>
      <button class="btn btn-danger" onclick="clearForm()">æ¸…ç©ºæ‰€æœ‰é—®å·</button>
      <button class="btn btn-primary" onclick="exportAllToExcel()">å¯¼å‡ºæ‰€æœ‰ Excel</button>
    </div>
    <hr>
    <h5>ğŸ“‹ å·²ä¿å­˜çš„å—è¯•è€…ç¼–å·ï¼š</h5>
    <ul id="savedList"></ul>
  </div>

  <script>
    const frequencyOptions = [">=3æ¬¡/å¤©", "2æ¬¡/å¤©", "1æ¬¡/å¤©", "4~6æ¬¡/å‘¨", "1~3æ¬¡/å‘¨", "1~3æ¬¡/æœˆ", "<1æ¬¡/æœˆ", "ä¸åƒ"];
    const unitOptions = ["g", "ä¸ª", "ç¢—",'æ¯'];
    const ffqData = `é¢åŠå…¶åˆ¶å“\tç³Œç²‘\né¢åŠå…¶åˆ¶å“\tè—é¢\né¢åŠå…¶åˆ¶å“\té¢æ¡\né¢åŠå…¶åˆ¶å“\té¦’å¤´\né¢åŠå…¶åˆ¶å“\tæ²¹é¥¼\né¢åŠå…¶åˆ¶å“\tå…¶ä»–é¢åŠå…¶åˆ¶å“ï¼ˆæŒ‚é¢æ²¹æ¡èŠ±å·çƒ§é¥¼ç­‰ï¼‰\nç±³åŠç±³åˆ¶å“\tç±³é¥­\nç±³åŠç±³åˆ¶å“\tå…¶ä»–ç±³åŠç±³åˆ¶å“ï¼ˆç²¥ï¼Œç±³ç²‰ç­‰ï¼‰\næœ‰é™·ç±»\tæœ‰é™·ç±»é£Ÿç‰©ï¼ˆåŒ…å­ã€é¥ºå­ï¼‰\nè–¯ç±»\té©¬é“ƒè–¯/åœŸè±†\nè–¯ç±»\tè—åŒºäººå‚æœ\nè–¯ç±»\tå…¶ä»–è–¯ç±»ï¼ˆçº¢è–¯ã€èŠ‹å¤´ã€å±±è¯ã€ç•ªè–¯ç­‰ï¼‰\næ‚ç²®ç±»\tæ‚ç²®ç±»ï¼ˆèéº¦ã€ç‡•éº¦ã€å°ç±³ã€é»‘ç±³ã€ç³™ç±³ã€ç‰ç±³ï¼‰\nçº¢è‚‰ç±»\tç‰¦ç‰›è‚‰ï¼ˆé²œï¼‰\nçº¢è‚‰ç±»\tç‰›è‚‰ï¼ˆé²œï¼‰\nçº¢è‚‰ç±»\tçŒªè‚‰ï¼ˆé²œï¼‰\nçº¢è‚‰ç±»\tå…¶ä»–æ–°é²œçº¢è‚‰ï¼ˆç¾Šè‚‰ã€å…”è‚‰ç­‰ï¼‰\nåŠ å·¥è‚‰ç±»\tç‰¦ç‰›è‚‰å¹²\nåŠ å·¥è‚‰ç±»\tå…¶ä»–åŠ å·¥è‚‰ï¼ˆè…Šè‚ ã€ç†è‚‰ã€åˆé¤è‚‰ã€ç«è…¿è‚‰ç­‰ï¼‰\nç¦½ç±»\tç¦½ç±»ï¼ˆé¸¡è‚‰ã€é¸­è‚‰ã€é¹…è‚‰ç­‰ï¼‰\nè›‹ç±»\tç™½é¸¡è›‹\nè›‹ç±»\tå…¶ä»–è›‹ç±»ï¼ˆé¸­è›‹ã€é¹Œé¹‘è›‹ç­‰ï¼‰\né±¼è™¾èŸ¹è´ç±»\té±¼è™¾èŸ¹è´ç±»\nå¤§è±†åŠå…¶åˆ¶å“\tå¤§è±†ç±»ï¼ˆé»‘è±†ã€é»„è±†ã€é’è±†ï¼‰\nå¤§è±†åŠå…¶åˆ¶å“\tè±†åˆ¶å“ï¼ˆè±†è…å¹²ã€è±†è…ä¸ç­‰ï¼‰\næ‚è±†ç±»\tæ‚è±†ç±»ï¼ˆç»¿è±†ã€çº¢è±†ã€èš•è±†ã€èŠ¸è±†ç­‰ï¼‰\nåšæœç±»\tåšæœç±»ï¼ˆèŠ±ç”Ÿã€æ ¸æ¡ƒã€ç“œå­ç­‰ï¼‰\næ·±è‰²è”¬èœç±»\tç»†é¦™è‘±\næ·±è‰²è”¬èœç±»\tè—èŒ´é¦™\næ·±è‰²è”¬èœç±»\tç•ªèŒ„/è¥¿çº¢æŸ¿\næ·±è‰²è”¬èœç±»\té’è¾£æ¤’\næ·±è‰²è”¬èœç±»\tå…¶ä»–æ·±è‰²è”¬èœç±»ï¼ˆè èœã€èƒ¡èåœã€ç©ºå¿ƒèœç­‰ï¼‰\næµ…è‰²è”¬èœç±»\tç™½èåœ\næµ…è‰²è”¬èœç±»\tèŠœè\næµ…è‰²è”¬èœç±»\tå¨ƒå¨ƒèœ\næµ…è‰²è”¬èœç±»\tå°ç™½èœ\næµ…è‰²è”¬èœç±»\tå…¶ä»–æµ…è‰²è”¬èœç±»ï¼ˆå¤§ç™½èœã€é»„ç“œã€è´è‹£ã€èŒ„å­ç­‰ï¼‰\nèŒè—»ç±»\té‡‘è˜‘è‡\nèŒè—»ç±»\tå…¶ä»–èŒè—»ç±»ï¼ˆé‡‘é’ˆè‡ã€å¹³è‡ã€æµ·è‰ç­‰ï¼‰\næ°´æœç±»\tè‹¹æœ\næ°´æœç±»\tæ¡ƒ\næ°´æœç±»\tæ©˜å­/æ¡”å­\næ°´æœç±»\té¦™è•‰\næ°´æœç±»\tå…¶ä»–æ°´æœç±»ï¼ˆè‘¡è„ã€è¥¿ç“œç­‰ï¼‰\nå¥¶ç±»\té…¥æ²¹\nå¥¶ç±»\tå¥¶æ¸£\nå¥¶ç±»\té²œç‰›å¥¶\nå¥¶ç±»\tå…¶ä»–å¥¶ç±»ï¼ˆé…¸å¥¶ã€å¥¶ç²‰ã€å¥¶é…ªç­‰ï¼‰\né¥®å“ç±»\té…¥æ²¹èŒ¶\né¥®å“ç±»\tè—èŒ¶/æ¸…èŒ¶\né¥®å“ç±»\tç”œèŒ¶\né¥®å“ç±»\tæ°´ï¼ˆå¼€æ°´ã€ç™½å¼€æ°´ï¼‰\né¥®å“ç±»\tå…¶ä»–é¥®æ–™ï¼ˆå¯ä¹ã€å¥¶èŒ¶ç­‰ï¼‰\né…’ç±»\té’ç¨é…’\né…’ç±»\té’ç¨å•¤é…’\né…’ç±»\tå•¤é…’\né…’ç±»\tç™½é…’\né…’ç±»\tçº¢/è‘¡è„é…’\né›¶é£Ÿç±»\té›¶é£Ÿï¼ˆæ–¹ä¾¿é¢ã€é¥¼å¹²ã€é¢åŒ…ã€è›‹ç³•ç­‰ï¼‰`;
    const freshnessOptions = ['è‚‰ç±»é‡èœéœ€é€‰æ–°é²œä¸å¦ æ°´æœè”¬èœé€‰æœ¬åœ°å¤–åœ°',"æ–°é²œ", "å†·å†»\å†·è—", "æœ¬åœ°",'å¤–åœ°'];
    const grouped = {};
    ffqData.split("\n").forEach(line => {
      const [category, item] = line.split("\t");
      if (!grouped[category]) grouped[category] = [];
      grouped[category].push(item);
    });

    function renderForm() {
      const form = document.getElementById("ffqForm");
      form.innerHTML = "";
      Object.entries(grouped).forEach(([category, items], index) => {
        const block = document.createElement("div");
        block.className = "category-block";
        const id = `category_${index}`;
        block.innerHTML = `
          <label><strong>${category}</strong></label><br>
          <label class="form-check-label">
            <input type="checkbox" class="form-check-input toggle-subitems" data-target="${id}"> åƒæ­¤ç±»é£Ÿç‰©
          </label>
          <div class="subitems hidden" id="${id}">
            ${items.map(item => `
              <div class="row mb-2">
                <div class="col-md-3">${item}</div>
                <div class="col-md-5 freq-options">
                  ${frequencyOptions.map(opt => `<label><input type='radio' name='freq_${item}' value='${opt}'> ${opt}</label>`).join(" ")}
                </div>
                <div class="col-md-4">
                  <input type="text" class="form-control amount" placeholder="æ•°é‡">
                  <select class="form-select mt-1 unit">
                    ${unitOptions.map(u => `<option>${u}</option>`).join("")}
                  </select>
                </div>
                <div class="col-md-2">
                  <select class="form-select freshness">
                    ${freshnessOptions.map(f => `<option>${f}</option>`).join("")}
                  </select>
               </div>
              </div>`).join("")}

          </div>`;
        form.appendChild(block);
      });

      document.querySelectorAll('.toggle-subitems').forEach(cb => {
        cb.addEventListener('change', () => {
          const target = document.getElementById(cb.dataset.target);
          target.classList.toggle('hidden', !cb.checked);
        });
      });
    }

    function saveForm(showBlank = false) {
      const id = document.getElementById("userId").value.trim();
      if (!id) return alert("è¯·å¡«å†™å—è¯•è€…ç¼–å·");

      const data = [];
      document.querySelectorAll('.category-block').forEach(block => {
        const category = block.querySelector("strong").innerText;
        const checked = block.querySelector("input[type='checkbox']").checked;
        if (!checked) return;

        block.querySelectorAll(".row").forEach(row => {
          const item = row.children[0].innerText;
          const freq = row.querySelector("input[type='radio']:checked")?.value || "æœªé€‰æ‹©";
          const amount = row.querySelector("input.amount")?.value.trim() || "";
          const unit = row.querySelector("select.unit")?.value || "";
          const freshness = row.querySelector("select.freshness")?.value || "";
          data.push([category, item, freq, amount, unit, freshness]);

        });
      });

      const savedAll = JSON.parse(localStorage.getItem("ffq_data_all") || '{}');
      savedAll[id] = data;
      localStorage.setItem("ffq_data_all", JSON.stringify(savedAll));

      alert("âœ… å½“å‰é—®å·å·²ä¿å­˜");
      listSavedIDs();
      if (showBlank) {
        document.getElementById("userId").value = "";
        renderForm();
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }
    }

    function clearForm() {
      if (confirm("âš ï¸ ç¡®å®šæ¸…é™¤æ‰€æœ‰ä¿å­˜çš„é—®å·æ•°æ®ï¼Ÿ")) {
        localStorage.removeItem("ffq_data_all");
        location.reload();
      }
    }

    function exportAllToExcel() {
      const savedAll = JSON.parse(localStorage.getItem("ffq_data_all") || '{}');
      const wb = XLSX.utils.book_new();
      Object.entries(savedAll).forEach(([id, data]) => {
        const ws_data = [["å—è¯•è€…ID", id], [], ["ç±»åˆ«", "é£Ÿç‰©", "é¢‘ç‡", "æ¯æ¬¡æ•°é‡", "å•ä½", "æ–°é²œæœ¬åœ°ä¸å¦"]];
        data.forEach(row => ws_data.push(row));
        const ws = XLSX.utils.aoa_to_sheet(ws_data);
        XLSX.utils.book_append_sheet(wb, ws, id);
      });
      XLSX.writeFile(wb, `æ‰€æœ‰FFQé—®å·.xlsx`);
    }

    function listSavedIDs() {
      const savedAll = JSON.parse(localStorage.getItem("ffq_data_all") || '{}');
      const list = document.getElementById("savedList");
      list.innerHTML = "";
      Object.keys(savedAll).forEach(id => {
        const li = document.createElement("li");
        li.innerHTML = `<a href="#" onclick="document.getElementById('userId').value='${id}'; renderForm(); fillForm('${id}'); return false;">${id}</a>`;
        list.appendChild(li);
      });
    }
    function fillForm(id) {
  const savedAll = JSON.parse(localStorage.getItem("ffq_data_all") || '{}');
  const data = savedAll[id];
  if (!data) return;

  data.forEach(([category, item, freq, amount, unit, freshness]) => {

    const block = [...document.querySelectorAll(".category-block")]
      .find(b => b.querySelector("strong").innerText === category);
    if (!block) return;
    const checkbox = block.querySelector("input[type='checkbox']");
    checkbox.checked = true;
    const subitems = block.querySelector(".subitems");
    subitems.classList.remove("hidden");

    const row = [...subitems.querySelectorAll(".row")]
      .find(r => r.children[0].innerText === item);
    if (row) {
      const radio = [...row.querySelectorAll("input[type='radio']")]
        .find(r => r.value === freq);
      if (radio) radio.checked = true;
      row.querySelector("input.amount").value = amount;
      row.querySelector("select.unit").value = unit;
      row.querySelector("select.freshness").value = freshness || "";
    }

  });
}


    renderForm();
    listSavedIDs();
  </script>
</body>
</html>